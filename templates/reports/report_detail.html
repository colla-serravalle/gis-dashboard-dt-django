{% extends 'base.html' %}
{% load static report_tags %}

{% block title %}Dettaglio Report #{{ object_id }} - GIS Dashboard{% endblock %}

{% block extra_head %}
<script type="text/javascript" src="{% static 'js/pdf-download.js' %}" defer></script>
{% endblock %}

{% block content %}
<a href="javascript:history.back()" class="standard-link text-link"><i class="fa-solid fa-circle-chevron-left"></i>Torna all'elenco</a>

{% if error %}
<div class="text-chunk">
    <h1>Errore</h1>
    <p>{{ error }}</p>
</div>
{% else %}

<div class="text-chunk">
    <h1>Dettaglio report #{{ object_id }}</h1>
</div>

<div id="route-logo-container">
    {% route_logo tratta_code %}
</div>

<div class="button-row">
    <form method="get" action="{% url 'reports:report_pdf' %}" id="pdf-download-form">
        <input type="hidden" name="rowid" value="{{ report_id }}">
        <button type="submit" class="standard-btn filled-lightgreen-btn">
            <i class="fa-solid fa-file-arrow-down"></i>Scarica PDF
        </button>
    </form>

    {% if maps_url %}
    <a href="{{ maps_url }}" target="_blank" class="standard-link filled-lightgreen-btn">
        <i class="fa-solid fa-location-dot"></i> Apri in Google Maps
    </a>
    {% endif %}
</div>

<h2>Localizzazione intervento</h2>
{% if location_data %}
<table>
    {% for attr in location_data %}
    <tr>
        <th>{{ attr.label }}</th>
        <td>{{ attr.value }}</td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>Nessun dato disponibile</p>
{% endif %}

<h2>Dati principali</h2>
{% if main_data %}
<table>
    {% for attr in main_data %}
    <tr>
        <th>{{ attr.label }}</th>
        <td>{{ attr.value }}</td>
    </tr>
    {% endfor %}
</table>
{% else %}
<p>Nessun dato disponibile</p>
{% endif %}

<h2>Dati pavimentazioni</h2>
{% if pk_pav_data %}
<table>
    <tr>
        {% for header in pk_pav_headers %}
        <th>{{ header }}</th>
        {% endfor %}
    </tr>
    {% for row in pk_pav_data %}
    <tr>
        {% for attr in row %}
        <td>{{ attr.value }}</td>
        {% endfor %}
    </tr>
    {% endfor %}
</table>
{% else %}
<p>Nessun dato disponibile per questa sezione.</p>
{% endif %}

<h2>Dati Imprese</h2>
{% if impresa_data %}
<table>
    <tr>
        {% for header in impresa_headers %}
        <th>{{ header }}</th>
        {% endfor %}
    </tr>
    {% for row in impresa_data %}
    <tr>
        {% for attr in row %}
        <td>
            {% if attr.field == 'n_squadra_pronto_int' %}
                {% for part in attr.value|default:""|split:"," %}
                <span class="tag-generico">{{ part|trim }}</span>
                {% empty %}
                {{ attr.value }}
                {% endfor %}
            {% else %}
                {{ attr.value }}
            {% endif %}
        </td>
        {% endfor %}
    </tr>
    {% endfor %}
</table>
{% else %}
<p>Nessun dato disponibile per questa sezione.</p>
{% endif %}

<h2>Allegati fotografici</h2>
{% if photos %}
<div class="photo-gallery">
    {% for photo in photos %}
    <div style="margin:10px; display:inline-block;">
        <a href="/api/image/{{ photo.layer }}/{{ photo.object_id }}/{{ photo.attachment_id }}/" target="_blank">
            <img src="/api/image/{{ photo.layer }}/{{ photo.object_id }}/{{ photo.attachment_id }}/" alt="Foto allegata" style="max-width:200px;">
        </a>
    </div>
    {% endfor %}
</div>
{% else %}
<p>Nessuna foto trovata.</p>
{% endif %}

{% endif %}

<div id="pdf-loading-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; justify-content:center; align-items:center; opacity:0; transition:opacity 0.3s ease;">
    <div style="background:white; padding:32px 48px; border-radius:16px; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.2);">
        <div style="width:48px; height:48px; border:4px solid #e0e0e0; border-top:4px solid #4caf50; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 16px;"></div>
        <p style="margin:0; font-size:16px; color:#333;">Generazione PDF in corso...</p>
    </div>
</div>
<style>
    @keyframes spin { to { transform: rotate(360deg); } }
</style>
{% endblock %}
